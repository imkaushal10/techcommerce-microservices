apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: techcommerce-staging

namePrefix: staging-

labels:
  - pairs:
      environment: staging

resources:
  - ../base

configMapGenerator:
  - name: app-config
    behavior: merge
    literals:
      - ENVIRONMENT=staging
      - LOG_LEVEL=debug

patches:
  # Frontend NodePort - Using 30100 for staging
  - patch: |-
      - op: replace
        path: /spec/ports/0/nodePort
        value: 30100
    target:
      kind: Service
      name: frontend-service

  # Backend replicas - 1 replica for staging
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      labelSelector: "tier=backend"

  # Memory requests for all deployments
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 64Mi
    target:
      kind: Deployment

  # Memory limits for all deployments
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 128Mi
    target:
      kind: Deployment
